{"id":"moon_cosmic-04v","title":"Update README: usage, parity status, dev commands","status":"closed","priority":2,"issue_type":"chore","created_at":"2026-01-30T14:09:00.36505+08:00","updated_at":"2026-01-30T14:10:17.037062+08:00","closed_at":"2026-01-30T14:10:17.037062+08:00","close_reason":"Closed","labels":["docs"],"comments":[{"id":36,"issue_id":"moon_cosmic-04v","author":"Milky2018","text":"Updated README.mbt.md: features, install, layout/draw examples, dev workflow commands, and embedded test-font regeneration steps.","created_at":"2026-01-30T06:10:11Z"}]}
{"id":"moon_cosmic-a11","title":"Update README: usage, parity status, dev commands","status":"open","priority":2,"issue_type":"chore","created_at":"2026-01-30T14:08:38.852554+08:00","updated_at":"2026-01-30T14:08:38.852554+08:00","labels":["docs"]}
{"id":"moon_cosmic-dhz","title":"Fix GitHub issue #1: per-span metrics + subpixel cache + font collection mapping","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-31T22:42:51.908601+08:00","updated_at":"2026-01-31T22:52:45.111064+08:00","closed_at":"2026-01-31T22:52:45.111064+08:00","close_reason":"Closed","labels":["github","release"],"comments":[{"id":37,"issue_id":"moon_cosmic-dhz","author":"Milky2018","text":"Implemented per-span metrics override (Attrs.metrics), carried into shaping/layout (LayoutGlyph.font_size/line_height_opt and LayoutLine.line_height_opt max), and made Buffer.layout_runs/draw respect per-line line_height_opt. Added FontSystem.get_font_entry for TTC/multi-face mapping. Updated README with integration notes (subpixel CacheKey + font collections). Bumped version to 0.1.1.","created_at":"2026-01-31T14:52:45Z"}]}
{"id":"moon_cosmic-mc2","title":"Implement moon_cosmic to match cosmic-text-reference using moon_swash","description":"Goal: bring this MoonBit cosmic port in src/ to feature parity (as scoped by tests and public API) with the reference implementation under ./cosmic-text-reference (user called it ./cosmic-reference).","status":"closed","priority":1,"issue_type":"epic","owner":"842376130@qq.com","created_at":"2026-01-29T10:03:46.212412+08:00","created_by":"Milky2018","updated_at":"2026-01-29T12:11:46.731988+08:00","closed_at":"2026-01-29T12:11:46.731988+08:00","close_reason":"Closed","labels":["cosmic","port"]}
{"id":"moon_cosmic-mc2.1","title":"Add/resolve dependency Milky2018/moon_swash","description":"Run moon add/update so Milky2018/moon_swash is resolvable; ensure moon test runs.","notes":"Installed moon_swash via moon add; fixed cmd/main to compile (prints cosmic_text_version); moon test passes.","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-01-29T10:03:54.716746+08:00","created_by":"Milky2018","updated_at":"2026-01-29T10:05:21.720003+08:00","closed_at":"2026-01-29T10:05:21.720006+08:00","labels":["deps"],"dependencies":[{"issue_id":"moon_cosmic-mc2.1","depends_on_id":"moon_cosmic-mc2","type":"parent-child","created_at":"2026-01-29T10:03:54.717411+08:00","created_by":"Milky2018"}]}
{"id":"moon_cosmic-mc2.2","title":"Replace MVP shaping with swash-based shaping/metrics","description":"Implement shaping and per-glyph advances using moon_swash; wire into layout/buffer.","notes":"Implemented core glyph cache primitives (CacheKey/SubpixelBin + tests), added minimal FontSystem backed by moon_swash, added ShapeLine::build_with_font_system using moon_swash charmap+metrics, and added SwashCache (moon_swash/scale) with image caching + with_pixels.\nAdded SwashCache outline commands cache (path data), variable font weight axis (wght) support, and fake italic transform handling for rendering parity.","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-01-29T10:03:54.794497+08:00","created_by":"Milky2018","updated_at":"2026-01-29T11:28:04.170833+08:00","closed_at":"2026-01-29T11:28:04.170833+08:00","close_reason":"Closed","labels":["shaping"],"dependencies":[{"issue_id":"moon_cosmic-mc2.2","depends_on_id":"moon_cosmic-mc2","type":"parent-child","created_at":"2026-01-29T10:03:54.795137+08:00","created_by":"Milky2018"}]}
{"id":"moon_cosmic-mc2.3","title":"Align public API/tests with reference","description":"Compare exposed types/functions with ./cosmic-text-reference; add/adjust tests for parity.","notes":"Added Buffer::layout_all + Buffer::layout_runs (LayoutRun) and fixed WordOrGlyph wrapping to account for skipped whitespace + correctly glyph-wrap overlong words; added wrap_word_fallback-style regression test.\nPorted render.rs (Renderer + LegacyRenderer) and added Buffer::draw wrapper + smoke test.","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-01-29T10:03:54.872607+08:00","created_by":"Milky2018","updated_at":"2026-01-29T11:28:14.458949+08:00","closed_at":"2026-01-29T11:28:14.458949+08:00","close_reason":"Closed","labels":["tests"],"dependencies":[{"issue_id":"moon_cosmic-mc2.3","depends_on_id":"moon_cosmic-mc2","type":"parent-child","created_at":"2026-01-29T10:03:54.873243+08:00","created_by":"Milky2018"}]}
{"id":"moon_cosmic-mc2.4","title":"Implement cluster shaping + bidi/rtl handling","description":"Switch ShapeLine/Buffer layout to operate on shaped glyph clusters (not 1 code unit = 1 glyph), add bidi paragraph direction + rtl shaping parity with cosmic-text-reference.","notes":"Added first-strong-direction RTL detection (ShapeLine.rtl) and made layout reverse glyph order when rtl; improved tab stop advance in font-based shaping (tabs snap to next stop like upstream).\nImplemented cluster-based shaping for Advanced via moon_swash/shape Shaper (size=1.0 em units) with UTF-16 code-unit offsets, propagated x/y offsets, added ShapeGlyph/ShapeLine constructors for blackbox tests; rewrote layout_from_shape to operate on glyph indices (not text length) with word/glyph wrapping based on glyph\u003c-\u003etext mapping and pixel-accurate advances; added regression tests for non-1:1 glyph coverage.\nRefined Advanced shaping to partition by unicode Script runs (Common/Inherited/Unknown treated as current), shaping each run separately with swash Shaper while preserving UTF-16 offsets.","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-01-29T10:43:14.043162+08:00","created_by":"Milky2018","updated_at":"2026-01-29T12:11:39.830644+08:00","closed_at":"2026-01-29T12:11:39.830644+08:00","close_reason":"Closed","labels":["bidi","shaping"],"dependencies":[{"issue_id":"moon_cosmic-mc2.4","depends_on_id":"moon_cosmic-mc2","type":"parent-child","created_at":"2026-01-29T10:43:14.043754+08:00","created_by":"Milky2018"}]}
{"id":"moon_cosmic-mc2.5","title":"Add Renderer/Buffer.draw API with SwashCache","description":"Port render.rs + Buffer.draw flow; use SwashCache::with_pixels to rasterize and invoke callback like upstream cosmic-text.","notes":"Implemented LayoutGlyph/PhysicalGlyph + LayoutGlyph::physical + CacheKey bin getters; added Buffer::draw_with_font_system that renders via SwashCache::with_pixels (legacy per-pixel callback).","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-01-29T10:43:14.117832+08:00","created_by":"Milky2018","updated_at":"2026-01-29T11:18:13.883841+08:00","closed_at":"2026-01-29T11:18:13.883841+08:00","close_reason":"Closed","labels":["render","swash"],"dependencies":[{"issue_id":"moon_cosmic-mc2.5","depends_on_id":"moon_cosmic-mc2","type":"parent-child","created_at":"2026-01-29T10:43:14.118554+08:00","created_by":"Milky2018"}]}
{"id":"moon_cosmic-vvr","title":"Full parity with cosmic-text-reference","description":"Match cosmic-text-reference functionality end-to-end: font system+fallback, shaping/bidi, layout, rendering, and editing APIs.","status":"closed","priority":1,"issue_type":"epic","owner":"842376130@qq.com","created_at":"2026-01-29T12:21:20.530205+08:00","created_by":"Milky2018","updated_at":"2026-01-30T13:58:07.43521+08:00","closed_at":"2026-01-30T13:58:07.43521+08:00","close_reason":"Closed","labels":["cosmic","parity"]}
{"id":"moon_cosmic-vvr.1","title":"Port math + shape_run_cache","description":"Add math helpers and shape run cache structures (ShapeRunKey/ShapeRunCache) like cosmic-text-reference, and wire into shaping pipeline where appropriate.","notes":"Added src/math.mbt (floorf/roundf/truncf) and src/shape_run_cache.mbt (ShapeRunKey/ShapeRunCache with get/peek/insert/trim) plus hashing support for Attrs/Family/Weight and unit tests.","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-01-29T12:21:33.26541+08:00","created_by":"Milky2018","updated_at":"2026-01-29T12:29:01.668912+08:00","closed_at":"2026-01-29T12:29:01.668912+08:00","close_reason":"Closed","labels":["cache","math"],"dependencies":[{"issue_id":"moon_cosmic-vvr.1","depends_on_id":"moon_cosmic-vvr","type":"parent-child","created_at":"2026-01-29T12:21:33.266163+08:00","created_by":"Milky2018"}]}
{"id":"moon_cosmic-vvr.2","title":"Port edit/editor module","description":"Implement cosmic-text edit module: Editor, selection, editing operations, and any vi helpers needed for parity with cosmic-text-reference.","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-01-29T12:21:33.350778+08:00","created_by":"Milky2018","updated_at":"2026-01-29T14:27:15.138431+08:00","closed_at":"2026-01-29T14:27:15.138431+08:00","close_reason":"Closed","labels":["edit"],"dependencies":[{"issue_id":"moon_cosmic-vvr.2","depends_on_id":"moon_cosmic-vvr","type":"parent-child","created_at":"2026-01-29T12:21:33.351438+08:00","created_by":"Milky2018"}],"comments":[{"id":1,"issue_id":"moon_cosmic-vvr.2","author":"Milky2018","text":"Added edit primitives (Action/Selection/Change/ChangeItem) + equality fixes; added edit tests; still need Editor + edit operations parity.","created_at":"2026-01-29T04:41:44Z"},{"id":2,"issue_id":"moon_cosmic-vvr.2","author":"Milky2018","text":"Added minimal Editor scaffold + selection_bounds (None/Normal/Line/Word with whitespace segmentation MVP) and tests. Added Buffer::set_redraw helper for cursor movement parity.","created_at":"2026-01-29T04:48:02Z"}]}
{"id":"moon_cosmic-vvr.2.1","title":"Implement Editor action/motion + insert/delete parity","description":"Port core Editor editing logic from cosmic-text-reference: action(), cursor motion, selection updates, insert_at/delete_range, change tracking (start/finish/apply).","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-01-29T12:49:21.194925+08:00","created_by":"Milky2018","updated_at":"2026-01-29T14:26:01.581779+08:00","closed_at":"2026-01-29T14:26:01.581779+08:00","close_reason":"Closed","labels":["edit"],"dependencies":[{"issue_id":"moon_cosmic-vvr.2.1","depends_on_id":"moon_cosmic-vvr.2","type":"parent-child","created_at":"2026-01-29T12:49:21.195464+08:00","created_by":"Milky2018"}],"comments":[{"id":3,"issue_id":"moon_cosmic-vvr.2.1","author":"Milky2018","text":"Implemented Editor.insert_at and Editor.delete_range (functional style) + tests. Insert_at currently treats attrs_list_opt as defaults-only (spans ignored) as MVP.","created_at":"2026-01-29T04:58:09Z"},{"id":4,"issue_id":"moon_cosmic-vvr.2.1","author":"Milky2018","text":"Implemented Editor action pipeline (Insert/Enter/Backspace/Delete/Indent/Unindent/Escape + text-index Motion) + copy_selection/delete_selection/insert_string/apply_change + change tracking for delete_range. Added editor_action_test.","created_at":"2026-01-29T05:13:30Z"},{"id":5,"issue_id":"moon_cosmic-vvr.2.1","author":"Milky2018","text":"Updated Editor.insert_at to apply full AttrsList (defaults+spans) and split attrs across inserted lines; added attrs split test.","created_at":"2026-01-29T05:16:40Z"},{"id":8,"issue_id":"moon_cosmic-vvr.2.1","author":"Milky2018","text":"Motion handling now delegates to Buffer::cursor_motion (layout-run based vertical movement + cursor_x_opt) instead of text-only cursor_motion.","created_at":"2026-01-29T05:30:58Z"},{"id":12,"issue_id":"moon_cosmic-vvr.2.1","author":"Milky2018","text":"Fixed SoftHome motion parity: Buffer::cursor_motion now toggles between after-leading-whitespace and column 0; non-vertical motions no longer require mapping cursor-\u003elayout run (avoids None for SoftHome). Added regression test.","created_at":"2026-01-29T05:56:53Z"},{"id":13,"issue_id":"moon_cosmic-vvr.2.1","author":"Milky2018","text":"Corrected SoftHome behavior to match cosmic-text-reference: always jump to first non-whitespace (no toggle) and return 0 for all-whitespace lines; updated tests.","created_at":"2026-01-29T06:01:43Z"},{"id":15,"issue_id":"moon_cosmic-vvr.2.1","author":"Milky2018","text":"Improved motion parity: Buffer::cursor_motion now supports Motion::LayoutCursor (visual-run based) and Home/End now operate on current visual run (wrap-aware) with affinity After/Before; added wrap regression test.","created_at":"2026-01-29T06:12:38Z"},{"id":17,"issue_id":"moon_cosmic-vvr.2.1","author":"Milky2018","text":"Completed additional Motion parity in Buffer::cursor_motion: Vertical/PageUp/PageDown now follow pixel/height semantics; PreviousWord/NextWord now cross line boundaries; added ParagraphStart/ParagraphEnd and GotoLine (LayoutCursor-based) + tests.","created_at":"2026-01-29T06:24:38Z"}]}
{"id":"moon_cosmic-vvr.2.2","title":"Upgrade word segmentation to UAX#29 for Selection::Word","description":"Replace whitespace-only segmentation used by Editor.selection_bounds with Unicode word boundary algorithm to match cosmic-text-reference (unicode_segmentation).","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-01-29T12:49:21.271228+08:00","created_by":"Milky2018","updated_at":"2026-01-29T13:38:13.626848+08:00","closed_at":"2026-01-29T13:38:13.626848+08:00","close_reason":"Closed","labels":["edit","segment"],"dependencies":[{"issue_id":"moon_cosmic-vvr.2.2","depends_on_id":"moon_cosmic-vvr.2","type":"parent-child","created_at":"2026-01-29T12:49:21.271817+08:00","created_by":"Milky2018"}],"comments":[{"id":9,"issue_id":"moon_cosmic-vvr.2.2","author":"Milky2018","text":"Added segment.word_indices_uax29 using moon_swash Analyze+Boundary; switched Selection::Word expansion to this; Buffer::cursor_motion now supports word motions using uax29 ranges.","created_at":"2026-01-29T05:37:22Z"}]}
{"id":"moon_cosmic-vvr.2.3","title":"Implement Editor render/cursor_position using Renderer","description":"Add Editor::render (and optional draw wrapper) that highlights selection and cursor using Renderer, aligned with cosmic-text-reference behavior. Needs LayoutRun metadata (line_top/line_height) or equivalent mapping.","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-01-29T12:49:21.34669+08:00","created_by":"Milky2018","updated_at":"2026-01-29T14:19:37.332901+08:00","closed_at":"2026-01-29T14:19:37.332901+08:00","close_reason":"Closed","labels":["edit","render"],"dependencies":[{"issue_id":"moon_cosmic-vvr.2.3","depends_on_id":"moon_cosmic-vvr.2","type":"parent-child","created_at":"2026-01-29T12:49:21.347275+08:00","created_by":"Milky2018"}],"comments":[{"id":6,"issue_id":"moon_cosmic-vvr.2.3","author":"Milky2018","text":"Extended Buffer::layout_runs with y/top/height; added Editor::cursor_position + generic Editor::render (selection/cursor highlight MVP) and tests with TestRenderer.","created_at":"2026-01-29T05:22:50Z"},{"id":7,"issue_id":"moon_cosmic-vvr.2.3","author":"Milky2018","text":"Added Buffer::hit + Buffer::set_scroll; wired Editor.action Click/DoubleClick/TripleClick/Drag/Scroll to hit-testing and scroll; added tests.","created_at":"2026-01-29T05:25:46Z"},{"id":16,"issue_id":"moon_cosmic-vvr.2.3","author":"Milky2018","text":"Improved Editor::render selection painting to match cosmic-text-reference: per-glyph grapheme subdivision (using grapheme_indices_uax29) and highlight internal empty lines (full width). Added regression test for empty-line selection highlight.","created_at":"2026-01-29T06:18:19Z"}]}
{"id":"moon_cosmic-vvr.2.4","title":"Align Indent/Unindent behavior with cosmic-text-reference","description":"Current Editor.action Indent/Unindent is MVP (line-start spaces). Port upstream tab-stop based indentation and cursor/selection adjustment semantics.","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-01-29T13:17:27.78654+08:00","created_by":"Milky2018","updated_at":"2026-01-29T13:50:15.243288+08:00","closed_at":"2026-01-29T13:50:15.243288+08:00","close_reason":"Closed","labels":["edit"],"dependencies":[{"issue_id":"moon_cosmic-vvr.2.4","depends_on_id":"moon_cosmic-vvr.2","type":"parent-child","created_at":"2026-01-29T13:17:27.78723+08:00","created_by":"Milky2018"}],"comments":[{"id":11,"issue_id":"moon_cosmic-vvr.2.4","author":"Milky2018","text":"Reimplemented Editor.action Indent/Unindent to match cosmic-text-reference tab-stop semantics: compute after_whitespace + last_indent, indent to next tab stop, deindent one tab stop chunk; adjust cursor/selection indices accordingly; added editor_indent_test.","created_at":"2026-01-29T05:49:27Z"}]}
{"id":"moon_cosmic-vvr.2.5","title":"Make Backspace/Delete and word motions grapheme-aware","description":"Use Unicode grapheme/word boundaries for Backspace/Delete and word motions (PrevWord/NextWord etc) to match cosmic-text-reference.","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-01-29T13:17:27.872665+08:00","created_by":"Milky2018","updated_at":"2026-01-29T14:26:01.508995+08:00","closed_at":"2026-01-29T14:26:01.508995+08:00","close_reason":"Closed","labels":["edit","segment"],"dependencies":[{"issue_id":"moon_cosmic-vvr.2.5","depends_on_id":"moon_cosmic-vvr.2","type":"parent-child","created_at":"2026-01-29T13:17:27.873357+08:00","created_by":"Milky2018"}],"comments":[{"id":10,"issue_id":"moon_cosmic-vvr.2.5","author":"Milky2018","text":"Added grapheme_indices_uax29 (UAX#29-ish) using moon_swash ClusterBreak; updated Editor.action Backspace/Delete to delete grapheme clusters; added combining-mark test.","created_at":"2026-01-29T05:41:42Z"},{"id":14,"issue_id":"moon_cosmic-vvr.2.5","author":"Milky2018","text":"Implemented grapheme-aware Previous/Next (and thus Left/Right in LTR fallback) in Buffer::cursor_motion using grapheme_indices_uax29; sets affinity to After/Before like upstream. Added regression test for combining mark cluster.","created_at":"2026-01-29T06:05:02Z"}]}
{"id":"moon_cosmic-vvr.3","title":"Implement FontSystem + font fallback parity","description":"Bring FontSystem/font module in line with cosmic-text-reference: font discovery, family/style/weight matching, fallback lists, and glyph availability checks.","notes":"Starting implementation: add glyph-availability checks + basic fallback selection using moon_swash Charmap/Attributes; wire into ShapeLine::build_with_font_system (multi-font runs).","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-01-29T12:21:33.437686+08:00","created_by":"Milky2018","updated_at":"2026-01-30T13:57:51.129199+08:00","closed_at":"2026-01-30T13:57:51.129199+08:00","close_reason":"Closed","labels":["fallback","font"],"dependencies":[{"issue_id":"moon_cosmic-vvr.3","depends_on_id":"moon_cosmic-vvr","type":"parent-child","created_at":"2026-01-29T12:21:33.43835+08:00","created_by":"Milky2018"}],"comments":[{"id":25,"issue_id":"moon_cosmic-vvr.3","author":"Milky2018","text":"Added a skipped port of upstream wrap_extra_line (wrap_stability.rs). Unskip requires real font metrics/proportional advances (FontSystem+fallback parity), otherwise overflow line counts diverge under the current monospace (cell_w=font_size) model.","created_at":"2026-01-29T07:30:24Z"},{"id":26,"issue_id":"moon_cosmic-vvr.3","author":"Milky2018","text":"Implemented FontSystem::resolve_for_codepoint (family+weight-aware, glyph-availability via swash Charmap) and wired ShapeLine::build_with_font_system to split shaping runs by (font_id, script) so missing glyphs can fall back to other loaded fonts. Added a synthetic-font unit test for resolve_for_codepoint.","created_at":"2026-01-29T07:41:59Z"},{"id":35,"issue_id":"moon_cosmic-vvr.3","author":"Milky2018","text":"FontSystem parity in this MoonBit port: implemented in-memory font loading + family/weight-aware resolve_for_codepoint via swash Charmap/Attributes, and wired ShapeLine.build_with_font_system to choose per-codepoint fallback fonts by (font_id, script) runs. Added Inter-Regular embedded test coverage via Buffer.layout_all_with_font_system (wrap_extra_line) and per-glyph font_weight propagation into CacheKey/Swash scaling.","created_at":"2026-01-30T05:57:45Z"}]}
{"id":"moon_cosmic-vvr.3.1","title":"Propagate font weight into layout/raster cache","description":"Match cosmic-text-reference: ShapeGlyph/LayoutGlyph carry per-glyph font_weight; CacheKey uses it for variable fonts and swash scaling. Implement: add ShapeGlyph.font_weight, set from AttrsList spans in ShapeLine::build/build_with_font_system; use it when building LayoutGlyph in layout_from_shape.","notes":"Implement ShapeGlyph.font_weight and propagate into LayoutGlyph.font_weight and CacheKey usage. Add regression test ensuring non-400 Attrs weight is reflected in LayoutGlyph.physical cache_key.","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-01-30T13:17:45.550221+08:00","created_by":"Milky2018","updated_at":"2026-01-30T13:27:41.473873+08:00","closed_at":"2026-01-30T13:27:41.473873+08:00","close_reason":"Closed","labels":["font","shape","swash"],"dependencies":[{"issue_id":"moon_cosmic-vvr.3.1","depends_on_id":"moon_cosmic-vvr.3","type":"parent-child","created_at":"2026-01-30T13:17:45.550986+08:00","created_by":"Milky2018"}]}
{"id":"moon_cosmic-vvr.4","title":"Implement bidi paragraph boundaries + visual runs","description":"Match cosmic-text bidi paragraph handling and visual order runs (beyond base-direction heuristic), including paragraph iteration and selection behavior.","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-01-29T12:21:33.524981+08:00","created_by":"Milky2018","updated_at":"2026-01-30T13:48:02.574674+08:00","closed_at":"2026-01-30T13:48:02.574674+08:00","close_reason":"Closed","labels":["bidi"],"dependencies":[{"issue_id":"moon_cosmic-vvr.4","depends_on_id":"moon_cosmic-vvr","type":"parent-child","created_at":"2026-01-29T12:21:33.525631+08:00","created_by":"Milky2018"}],"comments":[{"id":18,"issue_id":"moon_cosmic-vvr.4","author":"Milky2018","text":"Updated BidiParagraphs to better match cosmic-text-reference: ASCII fast path splits on \"\\n\" only; non-ASCII path splits on swash Properties::bidi_class() == B (Paragraph_Separator). Updated/added tests.","created_at":"2026-01-29T06:35:39Z"},{"id":20,"issue_id":"moon_cosmic-vvr.4","author":"Milky2018","text":"Buffer::cursor_motion now matches cosmic-text-reference RTL handling for Left/Right and LeftWord/RightWord by delegating to Next/Previous (word/grapheme) based on line shape rtl; added RTL regression test.","created_at":"2026-01-29T06:47:30Z"},{"id":21,"issue_id":"moon_cosmic-vvr.4","author":"Milky2018","text":"Made x/index mapping RTL-aware and order-independent: updated x_for_index/index_for_x in Buffer::cursor_motion and Editor::cursor_position/render helpers to handle glyphs in visual order with decreasing start indices; added RTL cursor_position test.","created_at":"2026-01-29T06:51:49Z"},{"id":22,"issue_id":"moon_cosmic-vvr.4","author":"Milky2018","text":"Improved Buffer::hit parity for RTL: returns correct index+affinity (After/Before) using run.rtl and min_start/max_end scanning (glyphs may be reversed). Added RTL hit regression test.","created_at":"2026-01-29T06:56:48Z"},{"id":29,"issue_id":"moon_cosmic-vvr.4","author":"Milky2018","text":"Added LayoutGlyph.level field (Int embedding level; LTR if even) with default 0 and per-line assignment (1 for rtl ShapeLine, 0 for ltr). This unblocks future bidi visual-run reordering work.","created_at":"2026-01-30T05:04:39Z"},{"id":33,"issue_id":"moon_cosmic-vvr.4","author":"Milky2018","text":"Implemented bidi visual reordering in layout: layout.build_layout_line_from_shape now reorders glyphs into visual order using embedding levels (UAX9-style reverse runs level=max..1). Added regression tests for LTR base with RTL run and RTL base with embedded LTR run; all tests pass.","created_at":"2026-01-30T05:47:57Z"}]}
{"id":"moon_cosmic-vvr.4.1","title":"Add per-glyph bidi levels (heuristic)","description":"Add ShapeGlyph.level and propagate to LayoutGlyph.level. Compute heuristic bidi levels from swash bidi classes: base level from first strong char; strong LTR in RTL paragraph gets level 2, strong RTL in LTR paragraph gets level 1, neutrals use base. (No full unicode-bidi yet.)","notes":"Implement ShapeGlyph.level + LayoutGlyph.level propagation; add tests for mixed LTR/RTL strings verifying per-glyph level assignment.","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-01-30T13:09:50.072383+08:00","created_by":"Milky2018","updated_at":"2026-01-30T13:16:17.904152+08:00","closed_at":"2026-01-30T13:16:17.904152+08:00","close_reason":"Closed","labels":["bidi","layout","shape"],"dependencies":[{"issue_id":"moon_cosmic-vvr.4.1","depends_on_id":"moon_cosmic-vvr.4","type":"parent-child","created_at":"2026-01-30T13:09:50.073034+08:00","created_by":"Milky2018"}],"comments":[{"id":30,"issue_id":"moon_cosmic-vvr.4.1","author":"Milky2018","text":"Implemented ShapeGlyph.level and propagated to LayoutGlyph.level in build_layout_line_from_shape. For now levels are line-level (base 0/1 from detect_base_rtl); next step is heuristic per-run levels for mixed-direction text.","created_at":"2026-01-30T05:12:23Z"},{"id":31,"issue_id":"moon_cosmic-vvr.4.1","author":"Milky2018","text":"Implemented heuristic per-code-unit bidi levels via compute_bidi_levels (uses swash bidi_class). RTL base =\u003e neutrals level 1, strong LTR level 2; LTR base =\u003e strong RTL level 1. Added tests in src/shape_bidi_level_test.mbt.","created_at":"2026-01-30T05:15:20Z"}]}
{"id":"moon_cosmic-vvr.5","title":"Port/align test suite with cosmic-text-reference","description":"Add MoonBit tests that mirror cosmic-text-reference behavior (layout, shaping, editing, selection, raster cache).","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-01-29T12:21:33.612474+08:00","created_by":"Milky2018","updated_at":"2026-01-30T13:55:31.883211+08:00","closed_at":"2026-01-30T13:55:31.883211+08:00","close_reason":"Closed","labels":["tests"],"dependencies":[{"issue_id":"moon_cosmic-vvr.5","depends_on_id":"moon_cosmic-vvr","type":"parent-child","created_at":"2026-01-29T12:21:33.613219+08:00","created_by":"Milky2018"}],"comments":[{"id":23,"issue_id":"moon_cosmic-vvr.5","author":"Milky2018","text":"Aligned Buffer::set_text with cosmic-text-reference: always ensures a trailing empty line with LineEnding::None (including empty text and trailing newline cases). Added tests.","created_at":"2026-01-29T07:02:20Z"},{"id":24,"issue_id":"moon_cosmic-vvr.5","author":"Milky2018","text":"Ported/added stable wrap regression test (based on cosmic-text-reference/tests/wrap_stability.rs) and fixed word-wrap stability by trimming leading/trailing whitespace consistently even when width_opt=None. Also added a skipped wrap_extra_line test stub; it currently depends on real font metrics (FontSystem/fallback parity).","created_at":"2026-01-29T07:27:44Z"},{"id":34,"issue_id":"moon_cosmic-vvr.5","author":"Milky2018","text":"Unskipped and aligned wrap_extra_line: added embedded Inter-Regular.ttf (base64) for tests, and switched test to Buffer.layout_all_with_font_system + Attrs family=Inter to match upstream metrics/overflow counts. All tests pass.","created_at":"2026-01-30T05:55:26Z"}]}
{"id":"moon_cosmic-vvr.6","title":"Implement Buffer::set_rich_text parity","description":"Port cosmic-text-reference Buffer::set_rich_text (and optionally set_text delegating to it): take spans of (text, attrs) + default attrs, build per-line AttrsList spans, and reset BufferLine text/layout caches consistently. Must align BidiParagraphs splitting behavior and upstream line-ending handling. Add tests for span splitting across lines and attrs spans.","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-01-29T14:38:42.453588+08:00","created_by":"Milky2018","updated_at":"2026-01-29T14:44:17.150965+08:00","closed_at":"2026-01-29T14:44:17.150965+08:00","close_reason":"Closed","labels":["attrs","buffer","text"],"dependencies":[{"issue_id":"moon_cosmic-vvr.6","depends_on_id":"moon_cosmic-vvr","type":"parent-child","created_at":"2026-01-29T14:38:42.45438+08:00","created_by":"Milky2018"}],"comments":[{"id":19,"issue_id":"moon_cosmic-vvr.6","author":"Milky2018","text":"Implemented Buffer::set_rich_text: concatenates spans, splits with BidiParagraphs, builds per-line AttrsList spans (only when attrs != defaults), applies alignment, uses LineEnding::default() for all lines. Added tests.","created_at":"2026-01-29T06:43:49Z"}]}
{"id":"moon_cosmic-vvr.7","title":"Align wrap/layout algorithm with cosmic-text-reference","description":"Port core wrap/layout algorithm nuances from cosmic-text-reference/src/shape.rs (word segments incl blanks, trimming trailing blanks, WordOrGlyph fallback to glyph wrap, RTL congruent direction handling). Update layout_from_shape/layout_ascii accordingly and add regression tests mirroring cosmic-text-reference/tests/wrap_word_fallback.rs + wrap_stability behaviors.","notes":"Implement UAX29-based word segments (blank-aware) in layout_from_shape; keep stable-wrap property; refine Word/WordOrGlyph behavior to match upstream trimming and overflow handling.\nRemaining: implement real UAX#14 linebreak opportunities (unicode_linebreak parity) for non-whitespace breakpoints; current wrap_word_segments is whitespace/blank-based MVP.","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-01-30T12:31:09.894617+08:00","created_by":"Milky2018","updated_at":"2026-01-30T13:41:17.458295+08:00","closed_at":"2026-01-30T13:41:17.458295+08:00","close_reason":"Closed","labels":["layout","wrap"],"dependencies":[{"issue_id":"moon_cosmic-vvr.7","depends_on_id":"moon_cosmic-vvr","type":"parent-child","created_at":"2026-01-30T12:31:09.89545+08:00","created_by":"Milky2018"}],"comments":[{"id":27,"issue_id":"moon_cosmic-vvr.7","author":"Milky2018","text":"Implemented cosmic-text-style word wrap segmentation (MVP): new segment.wrap_word_segments splits into non-blank runs and per-code-unit blank tokens (space/tab/nbsp), enabling correct trailing-blank trimming and WordOrGlyph fallback without duplicate end-of-input emission. Updated layout_ascii/layout_from_shape to use these segments; all tests pass.","created_at":"2026-01-30T04:48:57Z"},{"id":32,"issue_id":"moon_cosmic-vvr.7","author":"Milky2018","text":"Implemented UAX#14-style wrap segmentation: segment.wrap_word_segments now uses moon_swash.analyze Line/Mandatory boundaries and splits trailing whitespace per char (matching cosmic-text unicode_linebreak flow). Added hyphen break regression test; all tests pass.","created_at":"2026-01-30T05:41:05Z"}]}
{"id":"moon_cosmic-vvr.8","title":"Implement hinting + justified alignment parity","description":"Match cosmic-text-reference hinting semantics: when Hinting::Enabled, snap layout start x and glyph advances to integer pixels, affecting line widths and cursor/hit behavior. Also match Align::Justified semantics: distribute extra width across blank tokens (spaces) only, and do not justify the last visual line of a paragraph.","notes":"Start with Align::Justified last-line exclusion in BufferLine::layout (width_opt Some) and implement hinting rounding for x/x_advance under BufferLine::layout[_with_font_system] based on Buffer.hinting.","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-01-30T12:53:27.331725+08:00","created_by":"Milky2018","updated_at":"2026-01-30T13:02:41.668365+08:00","closed_at":"2026-01-30T13:02:41.668365+08:00","close_reason":"Closed","labels":["align","hinting","layout"],"dependencies":[{"issue_id":"moon_cosmic-vvr.8","depends_on_id":"moon_cosmic-vvr","type":"parent-child","created_at":"2026-01-30T12:53:27.332339+08:00","created_by":"Milky2018"}],"comments":[{"id":28,"issue_id":"moon_cosmic-vvr.8","author":"Milky2018","text":"Implemented Hinting::Enabled rounding in BufferLine.layout/layout_with_font_system (round start x and glyph advances, updating line.w). Implemented Align::Justified parity in BufferLine: justify only non-last visual lines (single-line paragraphs not justified), and default align is Right for RTL shapes. Added tests for justified last-line exclusion and hinting rounding; updated RTL cursor_position expectation accordingly.","created_at":"2026-01-30T04:59:49Z"}]}
{"id":"moon_cosmic-xgq","title":"Parity: strict logic equivalence with cosmic-text-reference","description":"Drive moon_cosmic to near-complete logic equivalence with cosmic-text-reference, prioritizing shaping/bidi/fallback correctness and visible-layout semantics.","status":"open","priority":0,"issue_type":"epic","owner":"842376130@qq.com","created_at":"2026-02-24T13:45:40.194933+08:00","created_by":"Milky2018","updated_at":"2026-02-24T13:45:40.194933+08:00","labels":["parity","reference","tracking"]}
{"id":"moon_cosmic-xgq.1","title":"P0 Shape parity: bidi runs, fallback shaping, cluster range semantics","description":"Align src/shape.mbt with reference shape.rs: unicode_bidi paragraph/run handling, fallback loop semantics, and per-glyph source-range invariants (including issue #2 symptom path).","notes":"Implemented first parity pass in src/shape.mbt: (1) per-glyph source range derivation from GlyphCluster components + end-fixup logic (LTR/RTL), (2) fallback run selection that retries candidate fonts when current run has missing glyph IDs, (3) tab-stop adjustment based on actual tab glyph advance, and (4) added regression tests in src/shape_range_test.mbt for space-glyph/source-range sanity and bounds invariants. Remaining for this issue: full unicode_bidi-equivalent run/level algorithm still not ported.\nCompleted for current parity phase: run-direction segmentation by bidi level parity, per-glyph source-range normalization for shaped clusters, fallback retry over alternate fonts when run has missing glyph IDs, and regression tests in src/shape_range_test.mbt.","status":"closed","priority":0,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-02-24T13:45:40.280203+08:00","created_by":"Milky2018","updated_at":"2026-02-24T13:58:07.952194+08:00","closed_at":"2026-02-24T13:58:07.952197+08:00","labels":["bidi","fallback","parity","shape"],"dependencies":[{"issue_id":"moon_cosmic-xgq.1","depends_on_id":"moon_cosmic-xgq","type":"parent-child","created_at":"2026-02-24T13:45:40.280895+08:00","created_by":"Milky2018"}]}
{"id":"moon_cosmic-xgq.2","title":"P0 Buffer parity: relayout/shape lifecycle, scroll-aware layout runs","description":"Align buffer lifecycle with reference: set_* relayout behavior, shape_until_scroll semantics, and visible layout run iteration semantics used by hit/cursor motions/render path.","notes":"Completed parity pass for buffer lifecycle + viewport semantics: set_wrap/set_hinting/set_monospace_width/set_metrics/set_size now invalidate cached layouts, set_tab_width invalidates shaping for tab-containing lines, layout_runs is scroll/height aware, draw_with_font_system renders via layout_runs, and cursor_motion now computes against unscrolled full-document runs. Added tests in src/buffer_test.mbt: wrap relayout invalidation, negative size clamp, and scroll-aware layout_runs.","status":"closed","priority":0,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-02-24T13:45:40.362841+08:00","created_by":"Milky2018","updated_at":"2026-02-24T14:09:56.952971+08:00","closed_at":"2026-02-24T14:09:56.952974+08:00","labels":["buffer","layout","parity","scroll"],"dependencies":[{"issue_id":"moon_cosmic-xgq.2","depends_on_id":"moon_cosmic-xgq","type":"parent-child","created_at":"2026-02-24T13:45:40.363481+08:00","created_by":"Milky2018"},{"issue_id":"moon_cosmic-xgq.2","depends_on_id":"moon_cosmic-xgq.1","type":"blocks","created_at":"2026-02-24T13:45:40.69245+08:00","created_by":"Milky2018"}]}
{"id":"moon_cosmic-xgq.3","title":"P1 Layout parity: layout_to_buffer semantics (wrap/align/justify/hinting/mono)","description":"Replace simplified layout pipeline with reference-equivalent visual-line/span-aware algorithm in layout/buffer_line paths.","status":"closed","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-02-24T13:45:40.445894+08:00","created_by":"Milky2018","updated_at":"2026-02-24T18:26:56.823825+08:00","closed_at":"2026-02-24T18:26:56.823825+08:00","close_reason":"Closed","labels":["hinting","justify","layout","parity","wrap"],"dependencies":[{"issue_id":"moon_cosmic-xgq.3","depends_on_id":"moon_cosmic-xgq","type":"parent-child","created_at":"2026-02-24T13:45:40.44649+08:00","created_by":"Milky2018"},{"issue_id":"moon_cosmic-xgq.3","depends_on_id":"moon_cosmic-xgq.2","type":"blocks","created_at":"2026-02-24T13:45:40.760629+08:00","created_by":"Milky2018"}],"comments":[{"id":38,"issue_id":"moon_cosmic-xgq.3","author":"Milky2018","text":"Aligned layout/buffer_line closer to reference: (1) set_ending now invalidates shaping+layout, (2) unified post-layout pipeline for align/justify/hinting with fallback empty visual line, (3) added RTL-aware Align::End semantics, (4) adjusted mono-width handling to snap per-glyph advance instead of replacing cell width, (5) added regression tests for set_align/set_ending, RTL End, whitespace-only wrap, and mono snapping. All tests passing (86/86).","created_at":"2026-02-24T08:17:20Z"},{"id":39,"issue_id":"moon_cosmic-xgq.3","author":"Milky2018","text":"Follow-up parity change: Buffer.layout_runs now mirrors reference precondition (requires shape+layout cache; stops when missing) and uses the same centered baseline path for all layout lines. Added regression test: layout_runs returns zero runs before layout_all.","created_at":"2026-02-24T08:19:15Z"},{"id":40,"issue_id":"moon_cosmic-xgq.3","author":"Milky2018","text":"Aligned word-wrapping blank handling closer to reference: (1) Wrap::Word/WordOrGlyph with width=None now keeps full glyph span (no blank trimming), (2) added width_before_last_blank-equivalent behavior so blank-overflow wraps no longer collapse to empty lines, (3) end-of-input keeps trailing blanks that fit, (4) added/updated tests in layout_test and buffer_line_test; stable_wrap matrix passes again.","created_at":"2026-02-24T08:46:40Z"},{"id":45,"issue_id":"moon_cosmic-xgq.3","author":"Milky2018","text":"Finalized layout parity pass in commit 4eaa6fb: removed leftover experimental mixed-bidi wrap code, kept reference-aligned wrap/align/hinting/mono behavior, and retained regression coverage. Verification: moon check pass, moon test pass (92/92).","created_at":"2026-02-24T10:26:56Z"}]}
{"id":"moon_cosmic-xgq.4","title":"P1 Font parity: matching/fallback selection and caches","description":"Align FontSystem matching and fallback selection semantics with reference (within MoonBit constraints), including deterministic font choice and codepoint-support fallback behavior.","status":"in_progress","priority":1,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-02-24T13:45:40.532889+08:00","created_by":"Milky2018","updated_at":"2026-02-24T17:05:57.34538+08:00","labels":["cache","fallback","font","parity"],"dependencies":[{"issue_id":"moon_cosmic-xgq.4","depends_on_id":"moon_cosmic-xgq","type":"parent-child","created_at":"2026-02-24T13:45:40.533489+08:00","created_by":"Milky2018"},{"issue_id":"moon_cosmic-xgq.4","depends_on_id":"moon_cosmic-xgq.3","type":"blocks","created_at":"2026-02-24T13:45:40.827307+08:00","created_by":"Milky2018"}],"comments":[{"id":41,"issue_id":"moon_cosmic-xgq.4","author":"Milky2018","text":"Started font-parity incremental step: added FontSystem codepoint-support cache (font_id+codepoint -\u003e bool) to avoid repeated charmap materialization, and updated family resolution to weight-aware selection (closest weight, deterministic id tie-break). Added regression tests for generic-family select fallback and repeated resolve_for_codepoint stability.","created_at":"2026-02-24T08:46:40Z"},{"id":42,"issue_id":"moon_cosmic-xgq.4","author":"Milky2018","text":"Second font-parity step: introduced a cached font-match pipeline (family+weight key -\u003e ordered font ids) and refactored resolve/resolve_for_codepoint to consume this order before codepoint checks, mirroring reference get_font_matches usage more closely. load_font_data now clears font-match cache. All tests still pass.","created_at":"2026-02-24T09:07:15Z"},{"id":44,"issue_id":"moon_cosmic-xgq.4","author":"Milky2018","text":"Added upstream-aligned font match cache lifecycle behavior: get_font_matches now clears font_matches_cache when it reaches size limit 256 (matching cosmic-text reference semantics). Verified with moon check and moon test (92/92).","created_at":"2026-02-24T10:14:56Z"}]}
{"id":"moon_cosmic-xgq.5","title":"P2 Attrs/segment parity and regression matrix","description":"Close remaining attrs/segment semantic gaps and add regression tests covering parity invariants and issue #2 reproducer.","status":"open","priority":2,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-02-24T13:45:40.618714+08:00","created_by":"Milky2018","updated_at":"2026-02-24T13:45:40.618714+08:00","labels":["attrs","parity","segment","tests"],"dependencies":[{"issue_id":"moon_cosmic-xgq.5","depends_on_id":"moon_cosmic-xgq","type":"parent-child","created_at":"2026-02-24T13:45:40.619308+08:00","created_by":"Milky2018"},{"issue_id":"moon_cosmic-xgq.5","depends_on_id":"moon_cosmic-xgq.4","type":"blocks","created_at":"2026-02-24T13:45:40.893786+08:00","created_by":"Milky2018"}]}
{"id":"moon_cosmic-xgq.6","title":"P0 Shape parity: cluster source ranges and fallback replacement","description":"Align ShapeLine::build_with_font_system with cosmic-text reference for cluster source span semantics and missing-glyph fallback replacement, addressing GitHub issue #2 (visible ASCII letters mapped to space glyph due source-range mismatch).","status":"in_progress","priority":0,"issue_type":"task","owner":"842376130@qq.com","created_at":"2026-02-24T18:07:15.552446+08:00","created_by":"Milky2018","updated_at":"2026-02-24T18:08:36.147855+08:00","external_ref":"gh-2","labels":["fallback","parity","shaping","source-range"],"dependencies":[{"issue_id":"moon_cosmic-xgq.6","depends_on_id":"moon_cosmic-xgq","type":"parent-child","created_at":"2026-02-24T18:07:15.553354+08:00","created_by":"Milky2018"}],"comments":[{"id":43,"issue_id":"moon_cosmic-xgq.6","author":"Milky2018","text":"Implemented reference-closer shaping changes for issue #2: (1) shape fallback now merges per-missing cluster (run glyph replacement) instead of selecting a single best fallback font for the entire run, (2) glyph metadata is now derived from attrs at glyph start (not cluster user-data), and (3) added shape regression tests for whitespace/source-range integrity and metadata mapping by glyph start. Verification: moon check OK, moon test OK (92/92).","created_at":"2026-02-24T10:08:41Z"}]}
